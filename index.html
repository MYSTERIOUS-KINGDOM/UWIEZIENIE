<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>WebAR â€“ wzmocniony start</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- â¶  LOKALNE biblioteki -->
<script src="libs/aframe-v1.5.0.min.js"></script>
<script src="libs/mindar-image.prod.js"></script>
<script src="libs/mindar-image-aframe.prod.js"></script>

<style>
  body{margin:0;overflow:hidden;font-family:system-ui,Arial}
  #msg{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
       background:#000;color:#fff;font-size:18px;z-index:9;text-align:center;padding:1rem}
  a-scene{width:100vw;height:100vh}
</style>
</head>

<body>
<div id="msg">ğŸ” Åadowanie bibliotekâ€¦</div>

<a-scene id="scene" embedded
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true"
         mindar-image="imageTargetSrc:targets.mind;autoStart:true;uiScanning:no">

  <a-assets>
    <img id="overlay" src="assets/czarodziej.png">
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async()=>{
  const M = document.getElementById('msg');
  const show = t => (M.textContent=t, M.style.display='flex');
  const hide = () => (M.style.display='none');

  /* â·  Weryfikacja bibliotek ------------------------------ */
  if(typeof AFRAME!=='object'){ return show('âŒ Biblioteka A-Frame nie zostaÅ‚a zaÅ‚adowana'); }
  if(typeof window.MINDAR==='undefined'){ return show('âŒ Biblioteka MindAR nie zostaÅ‚a zaÅ‚adowana'); }

  /* â¸  Czy plik targets.mind istnieje? -------------------- */
  try{
    const r = await fetch('targets.mind',{cache:'no-store'});
    if(!r.ok || r.headers.get('content-length')==='0'){
      return show('âŒ Brakuje pliku <targets.mind>\nlub ma rozmiar 0 B');
    }
  }catch(e){
    return show('âŒ Nie moÅ¼na pobraÄ‡ <targets.mind>\n'+e.message);
  }

  /* â¹  DostÄ™p do tylnej kamery ---------------------------- */
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    return show('âŒ Twoja przeglÄ…darka nie obsÅ‚uguje kamery (WebRTC)');
  }
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }
    });
    s.getTracks().forEach(t=>t.stop());          // zwolnij â€“ MindAR przejmie pÃ³Åºniej
  }catch(e){
    return show('âŒ DostÄ™p do kamery odrzucony'); 
  }

  hide();                     // wszystkie testy zaliczone â€“ chowamy komunikat

  /* âº  Logika pojawiania / ukrywania grafiki -------------- */
  const scene  = document.getElementById('scene');
  const anchor = document.getElementById('anchor');
  let timeout;                // â€watch-dogâ€ na brak markera

  scene.addEventListener('targetFound',()=>{
    clearTimeout(timeout);
    if(anchor.children.length===0){
      const plane = document.createElement('a-plane');
      plane.setAttribute('src','#overlay');
      plane.setAttribute('width','1');
      plane.setAttribute('height','0.75');
      plane.setAttribute('material','shader:flat;transparent:true');
      anchor.appendChild(plane);
    }
  });

  scene.addEventListener('targetLost',()=>{
    anchor.innerHTML='';      // usuÅ„ grafikÄ™
    /* jeÅ›li przez 15 s nie pojawi siÄ™ marker â€“ pokaÅ¼ podpowiedÅº */
    timeout = setTimeout(()=>{
      show('ğŸ•‘ Nie wykryto markera.\nUpewnij siÄ™, Å¼e kamera widzi obrazek-wizytÃ³wkÄ™.');
    },15000);
  });

  /* start timera przy pierwszym uruchomieniu sceny */
  timeout = setTimeout(()=>{
    show('ğŸ•‘ Trwa skanowanie.\nCzy marker jest dobrze oÅ›wietlony i w kadrze?');
  },15000);
})();
</script>
</body>
</html>
